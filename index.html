<!-- Кнопка -->
<button id="enterAR">Відкрити дзеркало</button>

<!-- Відео для fallback (імітація дзеркала, якщо AR недоступне) -->
<video
  id="mirror"
  autoplay
  playsinline
  muted
  style="display: none; width: 100%; height: 100%; object-fit: cover"
></video>

<script type="module">
  import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js";

  async function supportsWebXR() {
    if (!("xr" in navigator)) return false;
    try {
      return await navigator.xr.isSessionSupported("immersive-ar");
    } catch {
      return false;
    }
  }

  // --- Запуск WebXR (Android + Chrome) ---
  async function startWebXR() {
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(
      70,
      window.innerWidth / window.innerHeight,
      0.01,
      20
    );

    // cube (твоє "дзеркало")
    const geometry = new THREE.BoxGeometry(0.5, 1, 0.05);
    const material = new THREE.MeshBasicMaterial({ color: 0xaaaaaa });
    const mirror = new THREE.Mesh(geometry, material);
    mirror.position.set(0, 1.5, -2); // перед камерою
    scene.add(mirror);

    function animate() {
      renderer.setAnimationLoop(() => {
        renderer.render(scene, camera);
      });
    }

    try {
      const session = await navigator.xr.requestSession("immersive-ar", {
        requiredFeatures: ["local"],
      });
      renderer.xr.setSession(session);
      animate();
    } catch (e) {
      alert("Не вдалося запустити AR: " + e.message);
    }
  }

  // --- Відкрити Quick Look (iOS Safari) ---
  function openQuickLook() {
    const link = document.createElement("a");
    link.setAttribute("rel", "ar");
    link.setAttribute("href", "mirror.usdz");
    link.click();
  }

  // --- Fallback: камера ---
  async function startCameraFallback() {
    const video = document.getElementById("mirror");
    video.style.display = "block";
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
      });
      video.srcObject = stream;
    } catch (err) {
      alert("Не вдалося відкрити камеру: " + err.message);
    }
  }

  document.getElementById("enterAR").addEventListener("click", async () => {
    if (await supportsWebXR()) {
      startWebXR(); // Android Chrome
    } else if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
      openQuickLook(); // iOS Safari
    } else {
      startCameraFallback(); // fallback
    }
  });
</script>
